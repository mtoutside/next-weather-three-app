# 実装ロードマップ

このドキュメントは Next Weather Three App の実装ステップをまとめ、開発方針の継続と進捗の把握を助けます。

## 完了済み
- `useGeolocation` フックによる基本的な位置情報取得（テストあり）
- JMA（Open-Meteo JMA）から気温を取得し、`normalizeTempC` で正規化
- 正規化された気温値（`uTemp`）に応じて反応するシェーダ（fbm統合済み）
- fbm シェーダを `WeatherThreeScene` に統合（`app/shaders/fbm.ts`）
- FBO（オフスクリーン）でシェーダをテクスチャ化し、オブジェクトへマッピングする最小実装
  - フック: `useShaderFBOTexture`、例ページ: `/fbo-example`
- Weather（天気）拡張の土台
  - `weathercode` の日本語化（`weathercodeToJa`）
- Open-Meteo（forecast API）から `weathercode / temperature_2m / precipitation_probability / windspeed_10m` を取得しUIで可視化する実験ページ（`/open-meteo`）
- 降水確率・風速を `normalizePrecipProbability` / `normalizeWindSpeed` で正規化し、シェーダ uniform に反映（テスト済み）
  - APIルートでURL生成を `buildJmaUrlWithFields` に一元化（非破壊リファクタ）
- **統合天気予報アプリの完全実装** ✅ **完了**
  - `/` ページに統合天気予報アプリを構築（メインページ化）
  - 天気データ一元管理カスタムフック（`useWeatherData`）
  - 天気コード別3Dオブジェクト分岐ロジック（5パターン対応）
  - 背景シェーダー + 3Dオブジェクトの統合Canvas実装（`UnifiedWeatherScene`）
  - 深度バッファとレンダリング順序制御（renderOrder, depthTest制御）
  - パフォーマンス最適化（React.memo, uniforms最適化, ライティングメモ化）
  - 全画面背景シェーダー表示（150×100プレーン, FOV120度, 画面全体カバー）
- TDD/テストの整備
  - `normalize`, `useGeolocation`, `jma`（URL/取得/正規化）, `weathercode`, `fbm`（構造）, FBOヘルパ（`createFbmUniforms/smoothFollow/getFboSize`）のテスト
- **TweakPaneデバッグツールの実装** ✅ **完了**
  - 統合天気予報アプリにTweakPaneデバッグパネルを追加
  - 数値スライダー: `tempOverride`, `precipOverride`, `windOverride` (0-1範囲、0.01ステップ)
  - 天気コードセレクトボックス: `weathercodeOverride` (実際の天気コード値から選択)
  - 実データ/手動切り替えフラグ: `useRealData` (Boolean)
  - 天気コード選択肢の動的生成（`getWeathercodeOptions`）
  - 安定したTweakPane初期化とドラッグ可能なスライダー実装
  - 不要なCSSスタイル整理（緑色ボタン削除、globals.css最適化）

## 今後の予定
1. ~~**Open-Meteo 主要値の反映**: Open-Meteo から取得する「天気コード・気温・降水確率・風速」を shader uniform に接続し、温度や風の強弱、降水ステータスに応じたマテリアル変化を実装~~ ✅ **完了**
2. ~~**統合天気予報アプリの実装**: 現在分散している機能を統合し、完全な天気予報アプリを構築（詳細は下記「統合天気予報アプリの要件と実装計画」を参照）~~ ✅ **完了**
3. ~~**デバッグツールの実装**: TweakPaneでリアルタイムパラメータ調整機能を実装~~ ✅ **完了**
4. **自動更新とキャッシュ**: ポーリング/フォーカス時再検証（SWR等）＋ブラウザ/サーバキャッシュ。APIリクエスト間隔・Stale-While-Revalidate の戦略を決定
5. **API キーと環境変数の管理**: 他プロバイダ（OpenWeatherMap など）導入時に `.env` 管理、サーバ側での秘匿、型付け（`process.env`）
6. **堅牢なエラーハンドリング**: リトライ（指数バックオフ）、オフライン検出とフォールバック、位置情報拒否時の入力補助UIを強化
7. **UI/UX の向上**: レスポンシブ対応、アクセシビリティ改善、ローディング状態の視覚化
8. **テストと CI の整備**: 既存テストを維持拡充し、CI（GitHub Actions）で typecheck/lint/test を自動化
9. **パフォーマンス**: FBO解像度の自動調整、非アクティブ時のレンダ抑制、必要に応じて `LinearMipmapLinearFilter` 等の検証
10. **API設計の方針**: 現状 `/api/jma` は上流の生JSON互換を維持。正規化配列を返す新エンドポイントは要件が固まってから（バージョン/別パス）
11. **天気オブジェクトの球体シェーダ統一**: weathercode ごとに単一の `SphereGeometry` にシェーダ変調で表情付けする再設計
   - ✅ Clear: 既存の `MappedSphereFBO` により球体ベースの表現が成立
   - ✅ Cloudy: SphereGeometry を波・渦ノイズでうねらせた曇天シェーダを実装
   - ✅ Rain: SphereGeometry にシェーダ（simplex fbm + ripple）で雨雲・波紋表現を実装
   - ✅ Snow: TorusKnotGeometry + 波シェーダで結晶風トポロジを表現
   - ☐ Thunder: 球体を尖らせる変調

## 現在地の天気予報をシェーダに反映する実装方針
1. **位置情報の取得**: `navigator.geolocation` で緯度・経度を取得し、利用不可の場合はIPベースの位置情報APIを検討する。
2. **天気予報APIへのリクエスト**: Open-MeteoやOpenWeatherMapなどのAPIに座標を渡し、気温・降水量・天気コードなどを取得する。
3. **データの正規化**: 取得した値を0〜1などの扱いやすい範囲に変換し、必要なら数値コードにマッピングする。
4. **シェーダへの受け渡し**: 正規化した値を`uniform`としてシェーダに渡し、温度や降水量を表現のパラメータとして利用する。
5. **描画ロジック**: 天候に応じて色合いや動きを変化させる処理を実装する。例: 晴れ→光量増加、雨→パーティクル降下。
6. **更新処理**: 一定間隔でAPIを再取得し、シェーダを再描画して最新の天候を反映する。
7. **エラーハンドリング**: API失敗時のリトライやキャッシュ利用、位置情報拒否時のフォールバックUIを用意する。
8. **開発・デバッグ**: モックデータやGUIを活用してパラメータの確認や調整を行う。

## Open-Meteo 連携要件の整理
- **取得対象**: `weathercode`（天気）、`temperature_2m`（気温）、`precipitation_probability`（降水確率）、`windspeed_10m`（風速）を最低限取得する。降水確率は JMA モデルでは提供されないため、Open-Meteo の `/v1/forecast` エンドポイントを使用する。
- **シェーダ連携**: 上記の値を正規化し `uniform` としてシェーダへ送信。風速は流体・ノイズの速度、降水確率はエフェクト密度、気温は色味などに利用する。
- **画面表示**: 気温・降水確率を UI に表示し、天気コードに応じたアイコン（例: 晴れ=太陽、雨=雨雲）をシンプルなスタイルで配置する。風速は当面シェーダ内表現に注力し UI 表示は保留。
- **UI ポリシー**: 三要素（アイコン・気温・降水確率）を視認性重視で最小限の装飾に留める。レイアウトやタイポグラフィは余白とコントラストを活かし「こざっぱり」した印象を維持する。

## 背景シェーダ仕様
- **ベースシェーダ**: 既存の fbm ノイズを背景用に転用し、時間経過で緩やかにスクロールさせる。
- **色決定ロジック**: 気温 uniform を 0〜1 に正規化し、寒色（ディープブルー〜シアン）から暖色（アンバー〜サンセットオレンジ）へのグラデーション LUT を補間。低温ほど冷たい色味、高温ほど暖かい色味に寄せる。
- **補助効果**: 降水確率 uniform でコントラストと模様の粗さを調整、風速 uniform でスクロール方向と速度を変化させる。高温時はコントラスト高め、低温時は柔らかいトーンにして視覚的な温度感を表現。
- **uniform 利用**: 気温・降水確率・風速をすべて正規化して受け取り、`uTemp/uPrecip/uWind` に接続済み。将来的な気象オブジェクト側とも同じ正規化値を共有する。

## 天気ごとの 3D オブジェクト仕様（r3f）
- **クリアスフィア（weathercode 0–1）**: `SphereGeometry`。気温で表面カラーを補間し、降水確率でフレネル反射強度を調整。風速で自転速度とノイズ歪み量を変化させ晴天の静動感を演出。
- **レイヤーシェル（weathercode 2–4, 45, 48）**: メタボールベースの曇雲体。気温でボリューム膨張率、降水確率で等値面閾値（濃度）、風速で雲塊の流れ方向・速度を制御し、重い曇天から霧まで表現する。
- **リップルプレーン（weathercode 51–67, 80–82）**: `PlaneGeometry` に波紋シェーダ。気温で水色と粘性、降水確率で波振幅・頻度、風速でスクロール方向・速度を変え雨脚と風の影響を示す。
- **ストリーマー（weathercode 71–77, 85–86）**: `InstancedMesh` の雪片。気温で雪片サイズ・発光、降水確率で粒子密度、風速で降下角度と落下速度を操作し、粉雪から吹雪まで連続的に表現。
- **プラズマスパイア（weathercode 95–99）**: 稲妻状に揺れる `CylinderGeometry`。気温で発光色を変え、降水確率でパルス頻度とフォグ密度を調整。風速で柱のしなりとノイズスクロールを制御し嵐のダイナミクスを反映。

## 統合天気予報アプリの要件と実装計画

### 現在の実装状況（分散実装）
現在、天気関連機能が各画面に分散して実装されている：

1. **`/open-meteo`**: API連携 + shaderによる背景panel表示
   - Open-Meteo APIからの天気データ取得・表示
   - `WeatherThreeScene` による背景シェーダ（気温・降水確率・風速反映）
   - UIでの数値表示（気温・降水確率・風速・天気コード）

2. **`/fbo-example`**: 3Dオブジェクト（Sphere）表示
   - `MappedSphereFBO` によるFBOテクスチャマッピング
   - 手動温度入力によるシェーダ制御

3. **`/three`**: 基本的なThree.jsデモ（回転ボックス）

### 統合天気予報アプリの最終要件

#### UI表示要素
- **天気情報表示**: 現在の天気・気温・降水確率・風速を視認性の高いレイアウトで表示
- **天気に応じた3Dオブジェクト**: 天気コードに基づく動的3Dオブジェクト（球体・雲・雨粒・雪片・稲妻など）
- **天気に応じた背景シェーダ**: 気温・降水確率・風速を反映した動的背景エフェクト

#### 技術統合要件
- **単一ページ統合**: `/weather` または `/` で全機能を統合表示
- **リアルタイム同期**: API取得データが3Dオブジェクトと背景シェーダの両方に同時反映
- **天気コード分岐**: ROADMAPの「天気ごとの3Dオブジェクト仕様」に基づく条件分岐実装
- **UI/UXポリシー**: シンプル・こざっぱり・視認性重視のデザイン

### 統合実装ステップ

1. **統合コンポーネント設計**
   - `WeatherApp` メインコンポーネント作成
   - 天気データの一元管理（カスタムフック化）
   - 天気コード別3Dオブジェクト分岐ロジック

2. **天気コード別3Dオブジェクト実装**
   - クリアスフィア（weathercode 0-1）
   - レイヤーシェル（weathercode 2-4, 45, 48）
   - リップルプレーン（weathercode 51-67, 80-82）
   - ストリーマー（weathercode 71-77, 85-86）
   - プラズマスパイア（weathercode 95-99）

3. **UI統合とレイアウト設計**
   - 天気情報の表示レイアウト
   - 3Dビューと背景シェーダの配置
   - レスポンシブ対応

4. **既存機能の統合移行**
   - `/open-meteo` の機能を統合ページに移行
   - `/fbo-example` の3Dオブジェクト機能を統合
   - テスト・動作確認

5. **追加機能実装**
   - 位置情報自動取得と手動入力の両対応
   - エラーハンドリングとフォールバック表示
   - ローディング状態とオフライン対応

### 実装優先度
**高**: 統合コンポーネント設計・天気コード別3Dオブジェクト実装
**中**: UI統合・既存機能移行
**低**: 追加機能・最適化

## 現在の開発状況（2025年9月時点）

### 完成した主要機能
- ✅ **統合天気予報アプリ**: 位置情報取得、API連携、3D可視化がすべて統合
- ✅ **リアルタイム天気可視化**: 気温・降水確率・風速・天気コードによる動的シェーダー
- ✅ **天気別3Dオブジェクト**: 5パターンの天気条件に応じた3Dエフェクト
- ✅ **TweakPaneデバッグツール**: 開発者向けリアルタイムパラメータ調整
- ✅ **テスト駆動開発**: 主要機能の単体テスト完備

### 技術スタック
- **Frontend**: Next.js 15 (App Router), React 18, TypeScript
- **3D Graphics**: Three.js, React Three Fiber, GLSL Shaders
- **Weather API**: Open-Meteo JMA Model
- **Testing**: Jest, React Testing Library
- **Developer Tools**: TweakPane, ESLint, Prettier

### アーキテクチャの特徴
- **モジュラー設計**: 各機能が独立したフック・コンポーネントとして実装
- **型安全性**: TypeScript による厳密な型定義
- **パフォーマンス最適化**: React.memo、useCallback、依存配列の最適化
- **テスト可能性**: 純粋関数とカスタムフックの分離

タスクが完了したり新しいアイデアが出てきた場合は、このロードマップを更新してください。
