# 実装ロードマップ

このドキュメントは Next Weather Three App の実装ステップをまとめ、開発方針の継続と進捗の把握を助けます。

## 完了済み
- `useGeolocation` フックによる基本的な位置情報取得（テストあり）
- JMA（Open-Meteo JMA）から気温を取得し、`normalizeTempC` で正規化
- 正規化された気温値（`uTemp`）に応じて反応するシェーダ（fbm統合済み）
- fbm シェーダを `WeatherThreeScene` に統合（`app/shaders/fbm.ts`）
- FBO（オフスクリーン）でシェーダをテクスチャ化し、オブジェクトへマッピングする最小実装
  - フック: `useShaderFBOTexture`、例ページ: `/fbo-example`
- Weather（天気）拡張の土台
  - `weathercode` の日本語化（`weathercodeToJa`）
- Open-Meteo（forecast API）から `weathercode / temperature_2m / precipitation_probability / windspeed_10m` を取得しUIで可視化する実験ページ（`/open-meteo`）
  - APIルートでURL生成を `buildJmaUrlWithFields` に一元化（非破壊リファクタ）
- TDD/テストの整備
  - `normalize`, `useGeolocation`, `jma`（URL/取得/正規化）, `weathercode`, `fbm`（構造）, FBOヘルパ（`createFbmUniforms/smoothFollow/getFboSize`）のテスト

## 今後の予定
1. **Open-Meteo 主要値の反映**: Open-Meteo から取得する「天気コード・気温・降水確率・風速」を shader uniform に接続し、温度や風の強弱、降水ステータスに応じたマテリアル変化を実装
2. **自動更新とキャッシュ**: ポーリング/フォーカス時再検証（SWR等）＋ブラウザ/サーバキャッシュ。APIリクエスト間隔・Stale-While-Revalidate の戦略を決定
3. **API キーと環境変数の管理**: 他プロバイダ（OpenWeatherMap など）導入時に `.env` 管理、サーバ側での秘匿、型付け（`process.env`）
4. **堅牢なエラーハンドリング**: リトライ（指数バックオフ）、オフライン検出とフォールバック、位置情報拒否時の入力補助UIを強化
5. **UI/UX の向上**: デバッグGUI（leva 等）で uniform を操作、`/open-meteo` と FBO 表示の統合、状態表示の整理
6. **テストと CI の整備**: 既存テストを維持拡充し、CI（GitHub Actions）で typecheck/lint/test を自動化
7. **パフォーマンス**: FBO解像度の自動調整、非アクティブ時のレンダ抑制、必要に応じて `LinearMipmapLinearFilter` 等の検証
8. **API設計の方針**: 現状 `/api/jma` は上流の生JSON互換を維持。正規化配列を返す新エンドポイントは要件が固まってから（バージョン/別パス）

## 現在地の天気予報をシェーダに反映する実装方針
1. **位置情報の取得**: `navigator.geolocation` で緯度・経度を取得し、利用不可の場合はIPベースの位置情報APIを検討する。
2. **天気予報APIへのリクエスト**: Open-MeteoやOpenWeatherMapなどのAPIに座標を渡し、気温・降水量・天気コードなどを取得する。
3. **データの正規化**: 取得した値を0〜1などの扱いやすい範囲に変換し、必要なら数値コードにマッピングする。
4. **シェーダへの受け渡し**: 正規化した値を`uniform`としてシェーダに渡し、温度や降水量を表現のパラメータとして利用する。
5. **描画ロジック**: 天候に応じて色合いや動きを変化させる処理を実装する。例: 晴れ→光量増加、雨→パーティクル降下。
6. **更新処理**: 一定間隔でAPIを再取得し、シェーダを再描画して最新の天候を反映する。
7. **エラーハンドリング**: API失敗時のリトライやキャッシュ利用、位置情報拒否時のフォールバックUIを用意する。
8. **開発・デバッグ**: モックデータやGUIを活用してパラメータの確認や調整を行う。

## Open-Meteo 連携要件の整理
- **取得対象**: `weathercode`（天気）、`temperature_2m`（気温）、`precipitation_probability`（降水確率）、`windspeed_10m`（風速）を最低限取得する。降水確率は JMA モデルでは提供されないため、Open-Meteo の `/v1/forecast` エンドポイントを使用する。
- **シェーダ連携**: 上記の値を正規化し `uniform` としてシェーダへ送信。風速は流体・ノイズの速度、降水確率はエフェクト密度、気温は色味などに利用する。
- **画面表示**: 気温・降水確率を UI に表示し、天気コードに応じたアイコン（例: 晴れ=太陽、雨=雨雲）をシンプルなスタイルで配置する。風速は当面シェーダ内表現に注力し UI 表示は保留。
- **UI ポリシー**: 三要素（アイコン・気温・降水確率）を視認性重視で最小限の装飾に留める。レイアウトやタイポグラフィは余白とコントラストを活かし「こざっぱり」した印象を維持する。

## 背景シェーダ仕様
- **ベースシェーダ**: 既存の fbm ノイズを背景用に転用し、時間経過で緩やかにスクロールさせる。
- **色決定ロジック**: 気温 uniform を 0〜1 に正規化し、寒色（ディープブルー〜シアン）から暖色（アンバー〜サンセットオレンジ）へのグラデーション LUT を補間。低温ほど冷たい色味、高温ほど暖かい色味に寄せる。
- **補助効果**: 温度変化に応じて fbm のコントラストと露光も調整し、高温時はコントラスト高め、低温時は柔らかいトーンにして視覚的な温度感を表現する。
- **uniform 利用**: 気温は必須入力。降水確率・風速は背景では直接使用せず、将来的な拡張（雨量でノイズ密度、風速でスクロール速度）に備えて uniform パイプラインには残す。

## 天気ごとの 3D オブジェクト仕様（r3f）
- **クリアスフィア（weathercode 0–1）**: `SphereGeometry`。気温で表面カラーを補間し、降水確率でフレネル反射強度を調整。風速で自転速度とノイズ歪み量を変化させ晴天の静動感を演出。
- **レイヤーシェル（weathercode 2–4, 45, 48）**: メタボールベースの曇雲体。気温でボリューム膨張率、降水確率で等値面閾値（濃度）、風速で雲塊の流れ方向・速度を制御し、重い曇天から霧まで表現する。
- **リップルプレーン（weathercode 51–67, 80–82）**: `PlaneGeometry` に波紋シェーダ。気温で水色と粘性、降水確率で波振幅・頻度、風速でスクロール方向・速度を変え雨脚と風の影響を示す。
- **ストリーマー（weathercode 71–77, 85–86）**: `InstancedMesh` の雪片。気温で雪片サイズ・発光、降水確率で粒子密度、風速で降下角度と落下速度を操作し、粉雪から吹雪まで連続的に表現。
- **プラズマスパイア（weathercode 95–99）**: 稲妻状に揺れる `CylinderGeometry`。気温で発光色を変え、降水確率でパルス頻度とフォグ密度を調整。風速で柱のしなりとノイズスクロールを制御し嵐のダイナミクスを反映。

タスクが完了したり新しいアイデアが出てきた場合は、このロードマップを更新してください。
